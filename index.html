<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
<title>chainlink</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="chainlink">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#07070b">
<meta name="format-detection" content="telephone=no">
<link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxODAgMTgwIj48cmVjdCB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgcng9IjQwIiBmaWxsPSIjMDcwNzBiIi8+PHRleHQgeD0iOTAiIHk9IjExMCIgZm9udC1mYW1pbHk9Im1vbm9zcGFjZSIgZm9udC1zaXplPSI0OCIgZm9udC13ZWlnaHQ9IjcwMCIgZmlsbD0iIzAwZDRhYSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+4Lib4LiXPC90ZXh0Pjwvc3ZnPg==">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#07070b;--bgCard:#0d0d14;--bgCell:#141420;--bgCellHover:#1c1c30;--done:#00d4aa;--doneGlow:rgba(0,212,170,0.18);--skip:#f5a623;--skipGlow:rgba(245,166,35,0.14);--missed:#e0334c;--missedDim:rgba(224,51,76,0.35);--border:#1a1a28;--borderLight:#262640;--text:#d0d0d8;--textDim:#5a5a70;--textMuted:#2e2e42;--accent:#00d4aa;--accentSoft:rgba(0,212,170,0.07);--groupLabel:#7a7af0;--streakGold:#ffd700;--todayRing:rgba(0,212,170,0.45)}
body{background:var(--bg);color:var(--text);font-family:'JetBrains Mono',monospace;font-size:13px;line-height:1.5;min-height:100vh;-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;-webkit-tap-highlight-color:transparent;overscroll-behavior:none;padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left)}
button{cursor:pointer;font-family:inherit}
.header{padding:16px 20px 12px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;border-bottom:1px solid var(--border)}
.header-left{display:flex;align-items:center;gap:8px}
.logo-text{font-family:'Space Grotesk',sans-serif;font-weight:700;font-size:20px;color:var(--accent);letter-spacing:-0.02em;margin-left:2px}
.month-label{font-family:'Space Grotesk',sans-serif;color:var(--textDim);font-size:12px;font-weight:500;margin-left:10px}
.header-right{display:flex;align-items:center;gap:6px}
.day-badge{background:var(--accentSoft);color:var(--accent);border:1px solid rgba(0,212,170,0.12);padding:2px 9px;border-radius:20px;font-size:9px;font-weight:600}
.sync-dot{width:7px;height:7px;border-radius:50%;display:inline-block;margin-right:4px;vertical-align:middle}
.btn{background:transparent;color:var(--textDim);border:1px solid var(--border);padding:4px 11px;border-radius:5px;font-size:10px;transition:all .15s}
.btn:hover{color:var(--text);border-color:var(--borderLight);background:var(--bgCell)}
.btn-accent{background:var(--accentSoft);color:var(--accent);border-color:rgba(0,212,170,0.18)}
.btn-danger{color:var(--missed);border-color:rgba(224,51,76,0.2)}
.help-box{background:var(--bgCard);border:1px solid var(--border);border-radius:8px;padding:14px;margin:12px 20px;font-size:10px;color:var(--textDim);line-height:1.9}
.grid-wrap{padding:14px 16px;overflow:auto;-webkit-overflow-scrolling:touch}
.cell{border-radius:4px;background:var(--bgCell);border:1px solid var(--border);cursor:pointer;transition:all .12s ease;flex-shrink:0}
.cell:active{transform:scale(0.88);transition:transform .05s}
.cell:hover{background:var(--bgCellHover);border-color:var(--borderLight)}
.cell.done{background:var(--done);border-color:var(--done);box-shadow:0 0 8px var(--doneGlow),inset 0 1px 0 rgba(255,255,255,0.15)}
.cell.skip{background:var(--skip);border-color:var(--skip);box-shadow:0 0 6px var(--skipGlow)}
.cell.missed{background:var(--missedDim);border-color:rgba(224,51,76,0.5)}
.cell.today-cell{border-color:var(--accent);box-shadow:0 0 0 2px var(--todayRing);z-index:2;position:relative}
.cell.today-cell.done{box-shadow:0 0 0 2px var(--todayRing),0 0 8px var(--doneGlow)}
.cell.future{opacity:.15;cursor:default}.cell.future:hover{background:var(--bgCell)}.cell.future:active{transform:none}
.v-grid{display:flex;flex-direction:row;gap:0}
.v-label-col{display:flex;flex-direction:column;flex-shrink:0;padding-right:4px}
.v-label{display:flex;align-items:center;justify-content:flex-end;font-size:8px;color:var(--textMuted);font-weight:500;padding-right:3px;white-space:nowrap}
.v-label.today{color:var(--accent);font-weight:700;font-size:9px}
.v-label.future{opacity:.3}
.v-col{display:flex;flex-direction:column;align-items:center;flex-shrink:0}
.v-col-head{font-size:8px;color:var(--text);font-weight:600;writing-mode:vertical-lr;text-orientation:mixed;transform:rotate(180deg);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;letter-spacing:.02em}
.v-col-streak{display:flex;flex-direction:column;align-items:center;gap:1px}
.h-grid{display:flex;flex-direction:column;gap:0}
.h-header-row{display:flex;align-items:flex-end;gap:3px;margin-bottom:4px}
.h-day-hdr{display:flex;align-items:center;justify-content:center;font-size:8px;color:var(--textMuted);font-weight:500}
.h-day-hdr.today{color:var(--accent);font-weight:700}
.h-day-hdr.future{opacity:.3}
.h-group-label{color:var(--groupLabel);font-size:8px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;padding:10px 0 3px;border-top:1px solid var(--border);margin-top:2px}
.h-group-label.first{border-top:none;margin-top:0}
.h-habit-row{display:flex;align-items:center;padding:2px 0;gap:3px}
.h-habit-row:hover{background:rgba(255,255,255,0.008)}
.h-habit-name{font-size:11px;color:var(--text);text-align:right;padding-right:8px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-weight:500}
.h-streak-wrap{display:flex;align-items:center;gap:4px;padding-left:6px}
.h-score-row{display:flex;align-items:center;gap:3px;margin-bottom:6px}
.h-pip{height:5px;border-radius:2px}
.streak-num{font-size:11px;font-weight:700;font-family:'Space Grotesk',sans-serif;line-height:1}
.streak-lbl{font-size:7px;color:var(--textDim);font-weight:500}
.streak-fire{font-size:10px;line-height:1}
.stats{display:flex;gap:14px;padding:12px 16px 0;border-top:1px solid var(--border);margin-top:8px;font-size:10px;flex-wrap:wrap}
.stat{display:flex;align-items:baseline;gap:4px}
.stat-v{font-weight:700;font-family:'Space Grotesk',sans-serif}
.footer{padding:12px 16px;margin-top:14px;border-top:1px solid var(--border);display:flex;justify-content:space-between;font-size:8px;color:var(--textMuted)}
.footer a{color:var(--textDim);text-decoration:none}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.75);display:flex;align-items:center;justify-content:center;z-index:100;padding:20px}
.modal{background:var(--bgCard);border:1px solid var(--border);border-radius:10px;padding:22px;width:100%;max-width:520px;max-height:80vh;overflow-y:auto}
.modal h3{font-family:'Space Grotesk',sans-serif;color:var(--accent);font-size:15px;margin-bottom:4px}
.modal .hint{color:var(--textDim);font-size:10px;margin-bottom:12px;line-height:1.6}
.modal textarea{width:100%;min-height:220px;background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:6px;padding:12px;font-family:inherit;font-size:11px;line-height:1.7;outline:none;resize:vertical;-webkit-user-select:text;user-select:text}
.modal-btns{margin-top:12px;display:flex;gap:8px}
.tooltip{position:fixed;background:#181830;color:var(--text);border:1px solid var(--borderLight);padding:3px 7px;border-radius:4px;font-size:9px;pointer-events:none;z-index:200;white-space:nowrap;box-shadow:0 4px 14px rgba(0,0,0,0.5)}
.loading-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;gap:12px}
.loading-spinner{width:24px;height:24px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.layout-v{display:none}.layout-h{display:block}
@media(max-width:768px){.layout-v{display:block}.layout-h{display:none}.header{padding:12px 10px 10px}.grid-wrap{padding:10px 6px}.stats{padding:10px 8px 0}.footer{padding:10px 8px}.logo-text{font-size:17px}.month-label{font-size:11px;margin-left:6px}}
</style>
</head>
<body>
<div id="app"><div class="loading-screen"><div class="loading-spinner"></div><span style="color:var(--textDim);font-size:11px">connecting...</span></div></div>
<div id="tooltip" class="tooltip" style="display:none"></div>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script>
firebase.initializeApp({apiKey:"AIzaSyDDMb0ExBIRg0QZsT9SybamIJSwHPLLWSE",authDomain:"chainlink-517f2.firebaseapp.com",projectId:"chainlink-517f2",storageBucket:"chainlink-517f2.firebasestorage.app",messagingSenderId:"755636775713",appId:"1:755636775713:web:b5da5a269cb6ee55186c60"});
const auth=firebase.auth(),db=firebase.firestore();
db.enablePersistence({synchronizeTabs:true}).catch(()=>{});

const DEF=[{name:"Meditated",freq:1,group:"Dailies"},{name:"Exercise",freq:1,group:"Dailies"},{name:"Read 30min",freq:1,group:"Dailies"},{name:"Wrote",freq:1,group:"Dailies"},{name:"Cleaned apt",freq:7,group:"Weeklies"},{name:"Called family",freq:7,group:"Weeklies"},{name:"Finances",freq:30,group:"Monthly"}];
let S={habits:DEF,log:{},showEditor:false,editText:"",showHelp:false,uid:null,synced:false,ready:false};
let unsubLog=null,unsubHabits=null;

auth.signInAnonymously().catch(()=>{S.ready=true;render()});
auth.onAuthStateChanged(user=>{
  if(!user)return;
  S.uid=user.uid;S.synced=true;
  localStorage.setItem("chainlink-uid",user.uid);
  if(unsubHabits)unsubHabits();
  unsubHabits=db.collection("users").doc(S.uid).onSnapshot(doc=>{
    if(doc.exists&&doc.data().habits)S.habits=doc.data().habits;
    else saveHF();
    S.ready=true;render();
  },()=>{S.ready=true;render()});
  if(unsubLog)unsubLog();
  unsubLog=db.collection("users").doc(S.uid).collection("log").onSnapshot(snap=>{
    snap.docChanges().forEach(ch=>{
      const d=ch.doc.data();
      if(ch.type==="removed"){if(d.entries)Object.keys(d.entries).forEach(k=>delete S.log[k]);}
      else{if(d.entries)Object.assign(S.log,d.entries);}
    });
    render();
  });
});

function saveHF(){if(!S.uid)return;db.collection("users").doc(S.uid).set({habits:S.habits},{merge:true})}
function saveLE(k,v){if(!S.uid)return;const m=k.split("::")[1]?.substring(0,7)||"misc";db.collection("users").doc(S.uid).collection("log").doc(m).set({entries:{[k]:v}},{merge:true})}
function delLE(k){if(!S.uid)return;const m=k.split("::")[1]?.substring(0,7)||"misc";db.collection("users").doc(S.uid).collection("log").doc(m).update({["entries."+k]:firebase.firestore.FieldValue.delete()}).catch(()=>{})}

function dk(d){return d.toISOString().split("T")[0]}
function td(){return dk(new Date())}
function pd(s){return new Date(s+"T12:00:00")}
function getDow(s){return pd(s).getDay()}
function getDowS(s){return["Su","Mo","Tu","We","Th","Fr","Sa"][getDow(s)]}
function getMonthName(){return new Date().toLocaleString('default',{month:'long',year:'numeric'})}
function getTodayDate(){return new Date().getDate()}
function dim(){const n=new Date();return new Date(n.getFullYear(),n.getMonth()+1,0).getDate()}
function wim(){return Math.ceil(dim()/7)}

function getSlots(h){
  const now=new Date(),y=now.getFullYear(),m=now.getMonth(),f=h.freq;
  if(f>=28){
    const ms=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],sl=[];
    for(let i=0;i<12;i++){sl.push({key:y+"-M"+String(i).padStart(2,"0"),label:ms[i],isCurrent:i===m,isPast:i<m,isFuture:i>m,sortOrder:i===m?0:i<m?(m-i):(i-m+100)})}
    sl.sort((a,b)=>a.sortOrder-b.sortOrder);return{slots:sl,type:"monthly"};
  }
  if(f>=5){
    const w=wim(),cw=Math.ceil(getTodayDate()/7),sl=[];
    for(let i=1;i<=w;i++){sl.push({key:y+"-"+String(m).padStart(2,"0")+"-W"+i,label:"Wk "+i,isCurrent:i===cw,isPast:i<cw,isFuture:i>cw,sortOrder:i===cw?0:i<cw?(cw-i):(i-cw+100)})}
    sl.sort((a,b)=>a.sortOrder-b.sortOrder);return{slots:sl,type:"weekly"};
  }
  const d=dim(),td2=getTodayDate(),sl=[];
  for(let i=1;i<=d;i++){const dt=dk(new Date(y,m,i));sl.push({key:dt,label:String(i),dayLabel:getDowS(dt),isCurrent:i===td2,isPast:i<td2,isFuture:i>td2,sortOrder:i===td2?0:i<td2?(td2-i):(i-td2+100)})}
  sl.sort((a,b)=>a.sortOrder-b.sortOrder);return{slots:sl,type:"daily"};
}

function cellSt(h,k,isPast){const v=S.log[h.name+"::"+k];if(v==="y")return"done";if(v==="s")return"skip";if(isPast&&!v)return"missed";return"empty"}
function toggleCell(n,k,f){if(f)return;const key=n+"::"+k,c=S.log[key];if(!c){S.log[key]="y";saveLE(key,"y")}else if(c==="y"){S.log[key]="s";saveLE(key,"s")}else{delete S.log[key];delLE(key)}render()}

function lifeStreak(h){
  let s=0;
  if(h.freq<5){const d=new Date();for(let i=0;i<3650;i++){const v=S.log[h.name+"::"+dk(d)];if(v==="y")s++;else if(v==="s"){}else if(i===0){}else break;d.setDate(d.getDate()-1)}}
  else if(h.freq<28){const now=new Date();let y=now.getFullYear(),m=now.getMonth(),wk=Math.ceil(now.getDate()/7);for(let i=0;i<520;i++){const k=y+"-"+String(m).padStart(2,"0")+"-W"+wk;const v=S.log[h.name+"::"+k];if(v==="y")s++;else if(v==="s"){}else if(i===0){}else break;wk--;if(wk<1){m--;if(m<0){m=11;y--}wk=Math.ceil(new Date(y,m+1,0).getDate()/7)}}}
  else{const now=new Date();let y=now.getFullYear(),m=now.getMonth();for(let i=0;i<120;i++){const k=y+"-M"+String(m).padStart(2,"0");const v=S.log[h.name+"::"+k];if(v==="y")s++;else if(v==="s"){}else if(i===0){}else break;m--;if(m<0){m=11;y--}}}
  return s;
}
function ss(st){let c="var(--textMuted)",f="";if(st>=100){c="var(--streakGold)";f="ðŸ”¥"}else if(st>=30){c="var(--streakGold)";f="ðŸ”¥"}else if(st>=14){c="var(--accent)";f="ðŸ”¥"}else if(st>=7)c="var(--accent)";else if(st>=1)c="var(--textDim)";return{c,f}}
function groupH(l){const g=[];let c=null;l.forEach(h=>{if(!c||c.name!==h.group){c={name:h.group,habits:[]};g.push(c)}c.habits.push(h)});return g}
function parseH(t){const r=[];let g="Habits";t.split("\n").forEach(l=>{const s=l.trim();if(!s||s[0]==="#")return;if(s[0]==="!"){g=s.slice(1).trim();return}const p=s.split(":");if(p.length>=2)r.push({name:p[0].trim(),freq:parseInt(p[1])||1,group:g})});return r}
function toText(){let t="# chainlink habits\n# Name: freq (1=daily 7=weekly 30=monthly)\n# ! Group for headings\n\n",lg="";S.habits.forEach(h=>{if(h.group!==lg){t+="! "+h.group+"\n";lg=h.group}t+=h.name+": "+h.freq+"\n"});return t}
function esc(s){return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}
function chainSVG(sz){return`<svg width="${sz}" height="${sz}" viewBox="0 0 32 32" fill="none"><rect x="3" y="5" width="16" height="11" rx="5.5" stroke="var(--accent)" stroke-width="2.5" fill="none"/><rect x="13" y="16" width="16" height="11" rx="5.5" stroke="var(--accent)" stroke-width="2.5" fill="none"/></svg>`}
let ttEl;
function showTT(e,t){if(!ttEl)ttEl=document.getElementById("tooltip");ttEl.textContent=t;ttEl.style.display="block";const x=e.touches?e.touches[0].clientX:e.clientX,y=e.touches?e.touches[0].clientY:e.clientY;ttEl.style.left=Math.min(x+12,window.innerWidth-140)+"px";ttEl.style.top=(y-30)+"px"}
function hideTT(){if(!ttEl)ttEl=document.getElementById("tooltip");ttEl.style.display="none"}
function slotSz(so,mx,mn){if(so===0)return mx;if(so>=100)return mn;const d=Math.max(0,1-so*0.04);return Math.round(mn+(mx-4-mn)*d*d)}

function render(){
  if(!S.ready)return;
  const app=document.getElementById("app"),t=td(),todayD=getTodayDate(),d=dim(),rem=d-todayD,groups=groupH(S.habits);
  let html="";
  // Header
  html+=`<div class="header"><div class="header-left"><span>${chainSVG(28)}</span><span class="logo-text">chainlink</span><span class="month-label">${getMonthName()}</span></div><div class="header-right"><span class="day-badge"><span class="sync-dot" style="background:${S.synced?"var(--accent)":"var(--missed)"}"></span>Day ${todayD} Â· ${rem} left</span><button class="btn" onclick="openEd()">edit</button><button class="btn" onclick="S.showHelp=!S.showHelp;render()">?</button></div></div>`;
  if(S.showHelp){
    html+=`<div class="help-box"><div style="color:var(--accent);font-weight:600;margin-bottom:5px;font-size:11px">chainlink â€” build the chain</div><div><b style="color:var(--text)">Tap</b> â†’ <span style="color:var(--done)">done</span> â†’ <span style="color:var(--skip)">skip</span> â†’ clear. Today is always first.</div><div><b style="color:var(--text)">Daily</b>: days in month. <b>Weekly</b>: weeks in month. <b>Monthly</b>: 12 boxes (year).</div><div>Missed past = <span style="color:var(--missed)">red</span>. <span class="sync-dot" style="background:var(--accent)"></span> = synced via Firebase.</div><div style="margin-top:6px;display:flex;gap:5px;align-items:center;flex-wrap:wrap"><span style="display:inline-block;width:14px;height:14px;background:var(--done);border-radius:3px"></span>done <span style="display:inline-block;width:14px;height:14px;background:var(--skip);border-radius:3px;margin-left:6px"></span>skip <span style="display:inline-block;width:14px;height:14px;background:var(--missedDim);border:1px solid rgba(224,51,76,0.5);border-radius:3px;margin-left:6px"></span>missed <span style="display:inline-block;width:14px;height:14px;background:var(--bgCell);border:1px solid var(--border);border-radius:3px;margin-left:6px"></span>future</div><div style="margin-top:8px;display:flex;gap:6px"><button class="btn btn-danger" onclick="resetAll()">reset all data</button></div></div>`;
  }
  // VERTICAL
  html+=`<div class="layout-v"><div class="grid-wrap"><div class="v-grid">`;
  groups.forEach(g=>{
    const bt={};g.habits.forEach(h=>{const i=getSlots(h);if(!bt[i.type])bt[i.type]={slots:i.slots,type:i.type,habits:[]};bt[i.type].habits.push(h)});
    Object.values(bt).forEach(b=>{
      const sl=b.slots,MH=30,mH=16,G=3,CW=34,HH=65,SH=38;
      html+=`<div style="display:flex;flex-direction:row;margin-bottom:14px">`;
      html+=`<div class="v-label-col"><div style="height:${HH}px;display:flex;align-items:flex-end;justify-content:flex-end;padding-bottom:3px"><span style="font-size:7px;color:var(--groupLabel);font-weight:700;letter-spacing:.08em;text-transform:uppercase">${esc(g.name)}</span></div>`;
      sl.forEach(s=>{const h=slotSz(s.sortOrder,MH,mH);let c="v-label";if(s.isCurrent)c+=" today";else if(s.isFuture)c+=" future";let lb=s.label;if(s.dayLabel)lb=s.label+" "+s.dayLabel;html+=`<div class="${c}" style="height:${h}px;margin-bottom:${G}px">${lb}</div>`});
      html+=`<div style="height:${SH}px"></div></div>`;
      b.habits.forEach(h=>{
        const st=lifeStreak(h),s2=ss(st);
        html+=`<div class="v-col" style="padding:0 1px"><div style="height:${HH}px;display:flex;align-items:flex-end;justify-content:center;padding-bottom:3px;width:${CW}px"><div class="v-col-head" style="max-height:${HH-4}px">${esc(h.name)}</div></div>`;
        sl.forEach(s=>{const sz=slotSz(s.sortOrder,MH,mH),st2=cellSt(h,s.key,s.isPast);let c="cell";if(st2==="done")c+=" done";else if(st2==="skip")c+=" skip";else if(st2==="missed")c+=" missed";if(s.isCurrent)c+=" today-cell";if(s.isFuture)c+=" future";html+=`<div class="${c}" style="width:${CW}px;height:${sz}px;margin-bottom:${G}px" onclick="toggleCell('${esc(h.name)}','${s.key}',${s.isFuture})" onmouseenter="showTT(event,'${esc(h.name)} Â· ${s.label} Â· ${st2}')" onmouseleave="hideTT()"></div>`});
        html+=`<div class="v-col-streak" style="height:${SH}px;justify-content:center">`;if(s2.f)html+=`<span class="streak-fire">${s2.f}</span>`;html+=`<span class="streak-num" style="color:${s2.c}">${st}</span><span class="streak-lbl">${st===1?"day":"days"}</span></div></div>`;
      });
      html+=`</div>`;
    });
  });
  html+=`</div></div></div>`;
  // HORIZONTAL
  html+=`<div class="layout-h"><div class="grid-wrap"><div class="h-grid">`;
  groups.forEach((g,gi)=>{
    const bt={};g.habits.forEach(h=>{const i=getSlots(h);if(!bt[i.type])bt[i.type]={slots:i.slots,type:i.type,habits:[]};bt[i.type].habits.push(h)});
    Object.values(bt).forEach(b=>{
      const sl=b.slots,MW=28,mW=14,NW=140,SW=75;
      html+=`<div class="h-group-label ${gi===0?"first":""}">${esc(g.name)} <span style="font-weight:400;opacity:.5;text-transform:none;letter-spacing:0">(${b.type})</span></div>`;
      html+=`<div class="h-header-row"><div style="width:${NW}px;min-width:${NW}px"></div>`;
      sl.forEach(s=>{const w=slotSz(s.sortOrder,MW,mW);let c="h-day-hdr";if(s.isCurrent)c+=" today";else if(s.isFuture)c+=" future";html+=`<div class="${c}" style="width:${w}px">${s.label}</div>`});
      html+=`<div style="width:${SW}px"></div></div>`;
      html+=`<div class="h-score-row"><div style="width:${NW}px;min-width:${NW}px"></div>`;
      sl.forEach(s=>{const w=slotSz(s.sortOrder,MW,mW);let dn=0,tt=0;b.habits.forEach(h2=>{const v=S.log[h2.name+"::"+s.key];if(v==="s")return;tt++;if(v==="y")dn++});const sc=tt>0?dn/tt:(s.isFuture?-1:0);let bg;if(sc<0)bg="var(--bgCell)";else if(sc>.8)bg="var(--done)";else if(sc>.5)bg="rgba(0,212,170,0.45)";else if(sc>.2)bg="rgba(0,212,170,0.2)";else bg="rgba(224,51,76,0.2)";html+=`<div class="h-pip" style="width:${w}px;background:${bg}"></div>`});
      html+=`<div style="width:${SW}px"></div></div>`;
      b.habits.forEach(h=>{
        const st=lifeStreak(h),s2=ss(st);
        html+=`<div class="h-habit-row"><div class="h-habit-name" style="width:${NW}px;min-width:${NW}px">${esc(h.name)}</div>`;
        sl.forEach(s=>{const w=slotSz(s.sortOrder,MW,mW),st2=cellSt(h,s.key,s.isPast);let c="cell";if(st2==="done")c+=" done";else if(st2==="skip")c+=" skip";else if(st2==="missed")c+=" missed";if(s.isCurrent)c+=" today-cell";if(s.isFuture)c+=" future";html+=`<div class="${c}" style="width:${w}px;height:24px" onclick="toggleCell('${esc(h.name)}','${s.key}',${s.isFuture})" onmouseenter="showTT(event,'${esc(h.name)} Â· ${s.label} Â· ${st2}')" onmouseleave="hideTT()"></div>`});
        html+=`<div class="h-streak-wrap" style="width:${SW}px">`;if(s2.f)html+=`<span class="streak-fire">${s2.f}</span>`;html+=`<span class="streak-num" style="color:${s2.c}">${st}</span><span class="streak-lbl">${st===1?"day":"days"}</span></div></div>`;
      });
    });
  });
  html+=`</div></div></div>`;
  // Stats
  const totalDone=Object.values(S.log).filter(v=>v==="y").length;let mc=0;S.habits.forEach(h=>{const i=getSlots(h);i.slots.forEach(s=>{if(s.isPast&&!S.log[h.name+"::"+s.key])mc++})});
  html+=`<div class="stats"><div class="stat"><span style="color:var(--textDim)">Done</span> <span class="stat-v" style="color:var(--accent)">${totalDone}</span></div><div class="stat"><span style="color:var(--textDim)">Missed</span> <span class="stat-v" style="color:var(--missed)">${mc}</span></div><div class="stat"><span style="color:var(--textDim)">Habits</span> <span class="stat-v" style="color:var(--text)">${S.habits.length}</span></div><div class="stat"><span style="color:var(--textDim)">Lifetime</span> <span class="stat-v" style="color:var(--accent)">${totalDone} âœ“</span></div></div>`;
  html+=`<div class="footer"><span>${chainSVG(14)} chainlink</span><span>${t}</span></div>`;
  if(S.showEditor){html+=`<div class="overlay" onclick="if(event.target===this)closeEd()"><div class="modal"><h3>${chainSVG(20)} edit habits</h3><div class="hint">One per line: <b style="color:var(--text)">Name: frequency</b><br><b>1</b>=daily Â· <b>7</b>=weekly Â· <b>30</b>=monthly<br><b style="color:var(--groupLabel)">! Group</b> for headings Â· <b>#</b> comments</div><textarea id="editArea" spellcheck="false">${esc(S.editText)}</textarea><div class="modal-btns"><button class="btn btn-accent" onclick="saveEd()">save</button><button class="btn" onclick="closeEd()">cancel</button></div></div></div>`}
  app.innerHTML=html;
}

window.toggleCell=toggleCell;window.showTT=showTT;window.hideTT=hideTT;
window.openEd=function(){S.editText=toText();S.showEditor=true;render()};
window.closeEd=function(){S.showEditor=false;render()};
window.saveEd=function(){const a=document.getElementById("editArea");if(a){const p=parseH(a.value);if(p.length>0){S.habits=p;saveHF()}}S.showEditor=false;render()};
window.resetAll=function(){if(!confirm("Reset ALL chainlink data?"))return;S.habits=DEF;S.log={};if(S.uid){db.collection("users").doc(S.uid).collection("log").get().then(sn=>{const b=db.batch();sn.docs.forEach(d=>b.delete(d.ref));return b.commit()});saveHF()}render()};
</script>
</body>
</html>
